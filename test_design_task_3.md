# Тестовая задача: Таймлимиты

## Описание

При создании новой брони система автоматически назначает крайний срок выкупа билета (таймлимит). Если билеты не выкуплены к моменту истечения таймлимита, бронь аннулируется.

Правила назначения таймлимита задаются авиакомпанией в карточке **ТАЙМЛИМИТЫ**, содержащей одну или несколько записей:

| Поле   | Тип   | Комментарий |
|--------|------|-------------|
| ORDNO  | short | Порядковый номер записи в карточке авиакомпании |
| DatN   | date  | Дата начала действия записи. Пусто – нет ограничения |
| DatK   | date  | Дата окончания действия записи. Пусто – нет ограничения |
| MAXTERM | short | Максимальное количество дней до вылета, когда действует запись (0 - день вылета). Поле обязательное |
| MINTERM | short | Минимальное количество дней до вылета, когда действует запись (0 - день вылета). Поле обязательное |
| TLBASE  | char 8 | База для расчета таймлимита: ДВ – 00:00 даты вылета, ВВ - дата и время вылета, ДБР – 00:00 даты бронирования, ВБР - дата и время бронирования |
| TLVALUE | long  | Таймлимит в минутах относительно TLBASE. Может быть положительным и отрицательным |

Для определения таймлимита брони выбирается первая (по ORDNO) запись, удовлетворяющая условиям (DatN, DatK, MINTERM, MAXTERM). Окончательная величина таймлимита рассчитывается по формуле: `@tlbase + tlvalue`.

---

## Задача 1

### **Закодировать правила авиакомпании Россия (с 15 августа 2016)**

1. При бронировании **более чем за 15 суток** до вылета билеты должны быть выкуплены **до конца суток, следующих за сутками бронирования**.
2. При бронировании **за 1-15 суток** до вылета билеты должны быть выкуплены **до конца суток бронирования**.
3. При бронировании **в день вылета** билеты должны быть выкуплены **не позднее, чем за 6 часов до вылета**.

| OrdNo | DatN     | DatK | MaxTerm | MinTerm | BASE | TLVAL |
|-------|----------|------|---------|---------|------|-------|
|       | 15.08.16 |      | 360     | 16      | ДБР  | 2880  |
|       | 15.08.16 |      | 15      | 1       | ДБР  | 0     |
|       | 15.08.16 |      | 0       | 0       | ВВ   | -360  |

---

## Задача 2

### **Исправить таблицу авиакомпании Ютэйр (с 10 июля)**

**До 10 июля**:

1. При бронировании **более чем за 2 суток** до вылета билеты должны быть выкуплены **в течение 3 дней с момента бронирования**.
2. При бронировании **за 2 и менее суток** билеты должны быть выкуплены **в течение часа с момента бронирования**.

**С 10 июля**:

- При бронировании **более чем за 2 суток** до вылета билеты должны быть выкуплены **в течение 2 суток**.

| OrdNo | DatN     | DatK | MaxTerm | MinTerm | BASE | TLVAL |
|-------|----------|------|---------|---------|------|-------|
| 1     | 01.01.15 |      | 360     | 3       | ВБР  | 4320  |
| 2     | 01.01.15 |      | 2       | 0       | ВБР  | 60    |
| 3     | 10.07.15 |      | 360     | 3       | ВБР  | 2880  |

**Ошибка диспетчера**: запись 3 должна была переопределить предыдущее правило, но система продолжает использовать старые данные. Разработчикам следует проверить обработку записей по `OrdNo`.

---

## Задача 3

### **Исправить таблицу авиакомпании КрасАвиа**

**С 1 января 2015**:

1. При бронировании **более чем за 30 дней** билеты должны быть выкуплены **не позднее 20 дней до момента вылета**.
2. При бронировании **за 30-3 дней** билеты должны быть выкуплены **в течение 2 суток**.
3. При бронировании **менее чем за 2 суток** билеты должны быть выкуплены **в течение часа**.

| OrdNo | DatN     | DatK | MaxTerm | MinTerm | BASE | TLVAL |
|-------|----------|------|---------|---------|------|-------|
| 1     | 01.01.15 |      | 360     | 31      | ДВ   | -28800 |
| 2     | 01.01.15 |      | 30      | 3       | ВБР  | 2880  |
| 3     | 01.01.15 |      | 2       | 0       | ВБР  | 60    |

**Ошибка диспетчера**: при бронировании 1 августа на 1 октября система использовала неверный таймлимит. Вероятно, некорректно обрабатываются условия MINTERM/MAXTERM.

---

## Задача 4

### **Объяснение правил авиакомпании Ютэйр**

| OrdNo | DatN     | DatK | MaxTerm | MinTerm | BASE | TLVAL |
|-------|----------|------|---------|---------|------|-------|
| 1     | 10.07.15 |      | 360     | 20      | ДБР  | 28800 |
| 2     | 10.07.15 |      | 19      | 3       | ВБР  | 5760  |
| 3     | 10.07.15 |      | 2       | 0       | ВБР  | 120   |
| 4     | 01.01.15 |      | 360     | 20      | ВБР  | 14400 |
| 5     | 01.01.15 |      | 19      | 3       | ВБР  | 2880  |
| 6     | 01.01.15 |      | 2       | 0       | ВБР  | 60    |

**Вывод:**

- Бронирование **более чем за 20 суток** – выкуп за **20 дней до вылета**.
- Бронирование **за 19-3 суток** – выкуп в течение **2 суток**.
- Бронирование **за 2 суток и менее** – выкуп **в течение 2 часов**.

## Решение

### **Правила авиакомпании Россия (с 15 августа 2016)**

| OrdNo | DatN     | DatK | MaxTerm | MinTerm | BASE | TLVAL |
|-------|----------|------|---------|---------|------|-------|
| 1     | 15.08.16 |      | 360     | 16      | ДБР  | 2880  |
| 2     | 15.08.16 |      | 15      | 1       | ДБР  | 0     |
| 3     | 15.08.16 |      | 0       | 0       | ВВ   | -360  |

**Объяснение:**  

- Первая запись устанавливает правило для бронирований **более чем за 15 суток**: билеты должны быть выкуплены **до конца суток, следующих за сутками бронирования** (добавляем 24 часа, то есть 1440 минут * 2 = 2880 минут).
- Вторая запись действует **от 1 до 15 суток** до вылета: билеты должны быть выкуплены **до конца суток бронирования** (добавляем 0 минут к ДБР).
- Третья запись **на день вылета**: билеты должны быть выкуплены **не позднее, чем за 6 часов до вылета** (вычитаем 360 минут от времени вылета).

### **Исправление таблицы авиакомпании Ютэйр (с 10 июля)**

| OrdNo | DatN     | DatK | MaxTerm | MinTerm | BASE | TLVAL |
|-------|----------|------|---------|---------|------|-------|
| 1     | 01.01.15 |      | 360     | 3       | ВБР  | 4320  |
| 2     | 01.01.15 |      | 2       | 0       | ВБР  | 60    |
| 3     | 10.07.15 |      | 360     | 3       | ВБР  | 2880  |

**Объяснение:**  

- Запись 3 **с 10 июля** должна заменить первую запись для бронирований более чем за 2 суток до вылета. Таймлимит теперь **2 суток** (2880 минут), но система продолжает использовать старое правило. **Ошибка в обработке записей ORDNO**.

### **Исправление таблицы авиакомпании КрасАвиа**

| OrdNo | DatN     | DatK | MaxTerm | MinTerm | BASE | TLVAL |
|-------|----------|------|---------|---------|------|-------|
| 1     | 01.01.15 |      | 360     | 31      | ДВ   | -28800 |
| 2     | 01.01.15 |      | 30      | 3       | ВБР  | 2880  |
| 3     | 01.01.15 |      | 2       | 0       | ВБР  | 60    |

**Объяснение:**  

- При бронировании **1 августа на 1 октября** должно применяться правило для **бронирования более чем за 30 дней**. Вероятно, система **не учитывает условие MINTERM/MAXTERM правильно**.

### **Правила авиакомпании Ютэйр**

| OrdNo | DatN     | DatK | MaxTerm | MinTerm | BASE | TLVAL |
|-------|----------|------|---------|---------|------|-------|
| 1     | 10.07.15 |      | 360     | 20      | ДБР  | 28800 |
| 2     | 10.07.15 |      | 19      | 3       | ВБР  | 5760  |
| 3     | 10.07.15 |      | 2       | 0       | ВБР  | 120   |
| 4     | 01.01.15 |      | 360     | 20      | ВБР  | 14400 |
| 5     | 01.01.15 |      | 19      | 3       | ВБР  | 2880  |
| 6     | 01.01.15 |      | 2       | 0       | ВБР  | 60    |

**Вывод:**  

- Бронирование **более чем за 20 суток** – выкуп за **20 дней до вылета**.  
- Бронирование **за 19-3 суток** – выкуп в течение **2 суток**.  
- Бронирование **за 2 суток и менее** – выкуп **в течение 2 часов**.
